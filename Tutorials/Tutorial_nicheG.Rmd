---
title: "Function *niche.G*"
author: "Laura Jim√©nez and Carola Franzen"
date: "June 2021"
output: html_document
fontsize: 12pt
linkcolor: dodgerblue4
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(raster)
library(sp)
library(ggplot2)
library(ggpubr)
# needs package mvtnorm to be installed
```
\
  
\

# Project resulting ellipses back into G-space

The function niche.G projects ellipses that define suitable environments for a species on a raster map. Those potential niches in the geographical space are colored by different degrees of suitability.
\
\

### Parameters

* `Estck` = a raster stack with more than two climatic layers
\

* `mu` = the mean of the columns that contain environmental data, such as temperature and precipitation 
\

* `Sigma` = the covariance of the environmental data linked with a species' occurrence
\

\

### Dependencies

* `raster`
\

* `sp`
\

* `mvtnorm`
\

* `ggplot2`
\

* `ggpubr`
\

\


## Function's code

### How *niche.G* works

The function `niche.G` calculates suitability regions for a species based on environmental data and projects them onto a raster with geographical information. Each cell of the raster is weighed by an index of suitability.

```{r}
niche.G <- function(Estck, mu, Sigma, save.map) {
  
  # Calculate suitabilities in each cell
  max.val <- mvtnorm::dmvnorm(x=mu,mean = mu, sigma = Sigma)
  # function that calculates the log(suitability)
  sui.fun <- function(cell){log(mvtnorm::dmvnorm(x=c(cell[1],cell[2]),mean = mu, 
                                                 sigma = Sigma))-log(max.val)}
  # apply this function to the whole raster layer
  suit.rast <- calc(Estck,fun=sui.fun)
  # take exponential to go back to the original scale
  # save as ASCII
  suit.rast1 <- calc(suit.rast,fun = exp,
                     filename= paste0(save.map, ".asc"), overwrite=T)
  # save as TIFF
  writeRaster(suit.rast1, paste0(save.map, ".tif"), overwrite = T)
  
  return(suit.rast1)
}
```
\
\

### Output

The function will produce a geographical map that represents areas that have suitable environmental conditions for a species. Those potential ecological niche regions are colored by different degrees of suitability. The map will automatically be saved as a TIFF and as a ASCII file. It should be noted that the calculation of each cell in the raster might take a bit longer. 
\
\

## Worked Examples

<!-- Where should the library notice go? Is here okay? -->
### Upload libraries

```{r, eval=FALSE}
library(raster)
library(sp)
library(ggplot2)
library(ggpubr)
# needs package mvtnorm to be installed
```
\

### Input Data

The raster files need to contain information on climatic values that are of interest for the user. The rasters used in the examples below are from [WorldClim](https://worldclim.org/data/index.html) and have a resolution of "10 minutes".

Furthermore, a matrix that contains the corresponding environmental data of a species' occurrence is necessary. The matrix can be created by using the `get.Ecoord` function (see tutorial "Function *get.Ecoord*"). In this example, the environmental data are mean annual temperature and total annual precipitation.
\
\

### *Catasticta nimbice*

In this example, the basic plot function is used.

Read the rasters with environmental data and combine them into a rasterstack with two (or more layers).
```{r}
## Read raster
bio1 <- raster("./Input_Data/bio1WH.asc")
bio2 <- raster("./Input_Data/bio12WH.asc")
# combine the rasters into a RasterStack
bios <- stack(bio1,bio2)
```
\

For the species' occurrence points in correspondence with environmental data the "occ_GE.csv"-file that was created with `get.Ecoord` is used.
```{r}
# read table and omit columns with coordinates
occ <- read.csv("./Input_Data/Catasticta_nimbice_occ_GE.csv",header=T)[,-(1:2)]
```
\

The centroid is calculated by taking the means of the two columns in the matrix (`mu`). This parameter will set the values of the maximum likelhood estimate.
```{r}
center <- colMeans(occ)
```
\

Calculate the covariance of the environmental data (`Sigma`).
```{r}
boundary <- cov(occ)
```
\

Set the path and name under which the rasters will be saved (= `save.map`).
```{r}
saveM <- "./Output_Data/Catasticta_nimbice_map"
```
\

Apply the function `niche.G` with the parameters `Estck`, `mu`, and `Sigma` and plot it.

```{r, eval=FALSE}
result1 <- niche.G(Estck = bios, mu = center, Sigma = boundary, save.map = saveM)

# x11()
plot(result1)
```


```{r, echo=FALSE, fig.cap=" Figure of the geographical space with suitable niches for *Catasticta nimbice* .", out.width = '70%',fig.align="center"}
options(knitr.duplicate.label = "allow")
knitr::include_graphics("Images/Catasticta_nimbice_maha_asci.png")
```
\

\

### Threnetes ruckeri

This example uses the Mahalanobis distance and the weighted normal distribution. The graphs are plotted in `ggplot2`. The raster files are the same as above.

```{r, eval=FALSE}
## Read raster files
bio1 <- raster("./Input_Data/bio1WH.asc")
bio2 <- raster("./Input_Data/bio12WH.asc")
bios <- stack(bio1,bio2)
```
\
Load the matrix results of the weighted normal distribution that was calculated with the functions `rs.inE`, `negloglike`, and `fitNiche`.
```{r}
thr.fitN <- read.csv("./Input_Data/Threnetes_ruckeri_Estimated_parameters.csv",header=T)[,-1]
```
\

Set the saving name and location for the map of the weighted normal distribution and the Mahalanobis distance model.
```{r}
saveM2.wn <- "./Output_Data/Threnetes_ruckeri_wn_map"
saveM2.maha <- "./Output_Data/Threnetes_ruckeri_maha_map"
```
\

Apply the function with `mu`, `Sigma`, and `save.map` for each, the weighted normal distribution and the Mahalanobis distance model.
```{r, eval=FALSE}
# weighted normal
Thr.wn <- niche.G(Estck = bios, mu = thr.fitN$wn.mu, 
                  Sigma = cbind(thr.fitN$wn.sigma1, thr.fitN$wn.sigma2), 
                  save.map = saveM2.wn)
# Mahalanobis
Thr.maha <- niche.G(Estck = bios, mu = thr.fitN$maha.mu, 
                    Sigma = cbind(thr.fitN$maha.simga1, thr.fitN$maha.sigma2), 
                    save.map = saveM2.maha)
```
\

**Create a ggplot**

Read the species' occurrence data points that contain geographical information.
```{r}
species <- read.csv("./Input_Data/Threnetes_ruckeri_occ_GE.csv",header=T)
```
\

Load the previously created tif-file with the suitability levels for the Mahalanobis distance model and the weighted normal distribution model.
```{r}
maha.map <- raster("./Input_Data/Threnetes_ruckeri_maha_map.tif")

wn.map <- raster("./Input_Data/Threnetes_ruckeri_wn_map.tif")
```
\

Convert the raster to points and create a data-frame for ggplot. Name the columns of the new data-frame.
```{r}
# for Mahalanobis model
maha.mappt <- rasterToPoints(maha.map)
outp.maha <- data.frame(maha.mappt)
colnames(outp.maha) <- c("Longitude","Latitude","Suitability")

# for weighted normal model
wn.mappt <- rasterToPoints(wn.map)
outp.wn <- data.frame(wn.mappt)
colnames(outp.wn) <- c("Longitude","Latitude","Suitability")
```
\


Plot in ggplot.
```{r, fig.show='hide'}
p1 <- ggplot() +
  geom_tile(data = outp.maha,aes(x=Longitude, y=Latitude, fill=Suitability)) +
  theme_bw() +
  scale_fill_gradient2("Suitability",limits=c(0,1), low = 'grey80',
                       mid='slateblue1', high = 'slateblue4',na.value = NA,
                       midpoint = 0.5, n.breaks=4) +
  geom_point(data = species,aes(x=species[,1], y=species[,2]), shape = 23, fill = "yellowgreen") + 
  labs (title = "Mahalanobis distance model") +
  theme(plot.title = element_text(hjust = 0.5))

p2 <- ggplot() +
  geom_tile(data = outp.wn,aes(x=Longitude, y=Latitude, fill=Suitability)) +
  theme_bw() +
  scale_fill_gradient2("Suitability",limits=c(0,1), low = 'grey80',
                       mid='slateblue1', high = 'slateblue4',na.value = NA,
                       midpoint = 0.5, n.breaks=4) +
  geom_point(data = species,aes(x=species[,1], y=species[,2]), shape = 23, fill = "yellowgreen") +
  labs (title = "Weighted normal distribution model") +
  theme(plot.title = element_text(hjust = 0.5))

# x11()
ggarrange(p1, p2, ncol = 2, nrow = 1)
```


```{r, echo=FALSE, fig.cap=" Figure of the geographical space with suitable niches for *Threnetes ruckeri* using the Mahalanobis distance model and the weigthed normal distribution model in `ggplot2`.", out.width = '120%',fig.align="center"}
options(knitr.duplicate.label = "allow")
knitr::include_graphics("Images/Threnetes_ruckeri_ggplot.png")
```
\

Save the plot as a PNG.
```{r, eval=FALSE}
ggsave('./Output_Data/Threnetes_ruckeri_ggplot.png',  width = 48, height = 24, units = "cm",
       dpi = 600, pointsize = 6)
```
\


