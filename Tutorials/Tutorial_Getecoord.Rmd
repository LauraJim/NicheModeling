---
title: "How to export environmental data from raster files (with *get.ecoord*)"
author: "Laura Jim√©nez and Carola Franzen"
date: "June 2021"
output: pdf_document
fontsize: 12pt
linkcolor: dodgerblue4
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(dismo)

```
\
\
  
## Introduction

The function `get.ecoord` is a simple tool to extract environmental data, such as annual mean temperature or total annual precipitation, from raster-files that contain this type of information. The extracted data is then combined with the occurrence coordinates of a species. The output is a matrix that contains four or more columns: the coordinates of the species' occurrence (latitude and longitude) and the environmental variables for those coordinates.
\
  
### Input data

The raster files need to contain information on climatic values that are of interest for the user. The rasters used in the following examples are from [WorldClim](https://worldclim.org/data/index.html) and have a resolution of "10 minutes". The files usually do not need further editing.

The presence data of the species of interest needs to contain the coordinates of occurrence (longitude and latitude) in form of a table. 
Occurrence data is available on various open databases. For the following examples data from [GBIF](https://www.gbif.org/) was used. However, the tables from GBIF need to be cleaned up before they can be used as the database is aggregated from various sources with different formats and can contain various errors. There are packages available that aid in the cleaning of the data (e.g. see [CoordinateCleaner]( https://ropensci.github.io/CoordinateCleaner/articles/Cleaning_GBIF_data_with_CoordinateCleaner.html)).
\
\
  
## Parameters

For this function, three parameters are necessary:
\

**1) A raster stack that has two or more climatic layers, called `estck` **
  
```{r}

# read raster files
bio1 <- raster("./Input_Data/bio1WH.asc") # mean annual temperature 
bio12 <- raster("./Input_Data/bio12WH.asc") # total annual precipitation
# combine the rasters into a RasterStack # (will have as many layers as rasters 
# are combined together)
bios <- stack(bio1, bio12) #  = estck

```
\

**2) A matrix with two columns whose rows are geographic coordinates of species' occurrence in the study area, called `gcoord` **
  
```{r}
# read table, set header and omit first column of the table
occ <- read.csv("./Input_Data/Catasticta_nimbice.csv",header=T)[,-1] #  = gcoord

head(occ, n=3)

```
\

**3) Names for the extracted environmental variables in form of a character vector for the output table, called `enames` **
  
```{r}
# write names for the column heads of the environmental data
names1 <- c("bio1", "bio12") #  = enames


```
&nbsp;
  
## How *get.ecoord* works
  
The function `get.ecoord` will first check the amount of layers that a rasterstack has and makes sure that the numbers of entered names are the same. If the number of names and raster layers are the same amount, the climatic data for the species occurrence points are extracted from the rasters and combined into a matrix. Rows with no occurrence points are deleted. Finally, the columns are renamed by the coordinates and names that were entered into the function.
If less or more names are entered the message "Raster stack and enames does not have the same length" will be printed.  

Function:
```{r}
get.ecoord <- function(estck, gcoord, enames) {

  # check the amount of layers in a raster and make sure they are the same as the
  # names that are used
  if (length(estck@layers)==length(enames)) {  
    # extract climatic data from a raster
    a <- extract(estck,gcoord)  
    # combine columns of extracted coordinates with column of environmental data
    # and deletes rows with data points that are marked as NA
    b <- na.omit(cbind(gcoord,a)) 
    # rename the columns 
    colnames(b) <- c(colnames(gcoord),enames) 
    return(b)
  }
  else { 
    # if the amount of layers is not the same as the amount of added column names,
    # this message is printed instead
    print("Raster stack and enames does not have the same length.") 
  }
}
```
&nbsp;
  
## Output

The output of the function is a matrix with at least four variables. The first two columns are the longitude and latitude coordinates of the species' occurrence. The following columns are the environmental data that has been extracted from the raster files. In this example, it is the mean annual temperature (column name = bio1) and the total annual precipitation (column name = bio12).

Apply *get.ecoord* with the parameters `estck`, `gcoord`, and `enames`:
```{r}
f <- get.ecoord(estck=bios, gcoord=occ, enames=names1)

head(f, n=3)

```
&nbsp;

Save the output as a csv-file:
```{r}
write.csv(f,file=paste0("./Output_Data/Catasticta_nimbice","_bios.csv"),
          row.names = F)
```


This csv-file can now be used as data input for various graphs that highlight the geographical presence of the species and the surrounding environment.
&nbsp;

&nbsp;

## Examples
\

#### Catasticta Nimbice

```{r}
bio1 <- raster("./Input_Data/bio1WH.asc") 
bio12 <- raster("./Input_Data/bio12WH.asc") 
bios <- stack(bio1, bio12)

names1 <- c("bio1", "bio12") 

occ <- read.csv("./Input_Data/Catasticta_nimbice.csv",header=T)[,-1] 

f <- get.ecoord(estck=bios, gcoord=occ, enames=names1)

write.csv(f,file=paste0("./Output_Data/Catasticta_nimbice","_bios.csv"),
          row.names = F)
```
&nbsp;

#### Threnetes Ruckeri

```{r}
bio1 <- raster("./Input_Data/bio1WH.asc") 
bio12 <- raster("./Input_Data/bio12WH.asc") 
bios <- stack(bio1, bio12)

names1 <- c("bio1", "bio12") 

occ2 <- read.csv("./Input_Data/Threnetes_ruckeri_occ.csv",header=T)[,-1]

f2 <- get.ecoord(estck=bios, gcoord=occ2, names1) 

write.csv(f2,file=paste0("./Output_Data/Threnetes_ruckeri_occ","_bios.csv"),
          row.names = F)
```

  